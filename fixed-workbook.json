{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# AVD Storage Analytics & ANF Planning\r\n## Comprehensive analysis of AVD storage performance, user patterns, and Azure NetApp Files sizing recommendations\r\n\r\n### 📊 This workbook provides:\r\n- **Real-time Storage Performance Analysis** - IOPS, throughput, latency metrics\r\n- **User Session Patterns** - Peak usage times, concurrent users, session duration\r\n- **Profile Analytics** - FSLogix container sizes, growth trends, performance\r\n- **ANF Sizing Recommendations** - Performance tier suggestions based on actual usage\r\n- **Cost Optimization Insights** - Right-sizing recommendations and cost projections\r\n\r\n---"
      },
      "name": "Title"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "timeRange",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "description": "Select the time range for analysis",
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000,
                  "displayName": "Last 1 hour"
                },
                {
                  "durationMs": 86400000,
                  "displayName": "Last 24 hours"
                },
                {
                  "durationMs": 604800000,
                  "displayName": "Last 7 days"
                },
                {
                  "durationMs": 2592000000,
                  "displayName": "Last 30 days"
                }
              ]
            }
          },
          {
            "id": "workspace",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "label": "Log Analytics Workspace",
            "type": 5,
            "description": "Select the Log Analytics workspace containing AVD data",
            "isRequired": true,
            "query": "Resources\r\n| where type == 'microsoft.operationalinsights/workspaces'\r\n| project id, name, subscriptionId, resourceGroup\r\n| order by name asc",
            "crossComponentResources": [
              "value::all"
            ],
            "value": "value::1",
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            },
            "defaultValue": "value::1"
          },
          {
            "id": "hostPools",
            "version": "KqlParameterItem/1.0",
            "name": "HostPools",
            "label": "Host Pools",
            "type": 2,
            "description": "Select specific host pools to analyze",
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "WVDConnections\r\n| where TimeGenerated {TimeRange}\r\n| distinct ResourceAlias\r\n| sort by ResourceAlias asc",
            "value": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*"
            },
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          }
        ]
      },
      "name": "Parameters"
    },
    {
      "type": 1,
      "content": {
        "json": "## 📈 Executive Summary Dashboard\r\n\r\nKey performance indicators and quick insights for storage planning decisions."
      },
      "name": "ExecutiveSummaryHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let timeRange = {TimeRange};\r\nlet hostPools = dynamic([{HostPools}]);\r\n// Storage Performance Overview\r\nPerf\r\n| where TimeGenerated >= ago({TimeRange:grain})\r\n| where CounterName in (\"Disk Read Bytes/sec\", \"Disk Write Bytes/sec\", \"Current Disk Queue Length\", \"Avg. Disk sec/Read\", \"Avg. Disk sec/Write\")\r\n| where InstanceName != \"_Total\" and InstanceName !contains \"Harddisk\"\r\n| extend DiskLetter = extract(@\"([A-Z]):\", 1, InstanceName)\r\n| where DiskLetter in (\"C\", \"D\", \"O\", \"P\", \"S\", \"T\", \"U\", \"V\", \"W\", \"X\", \"Y\", \"Z\") // Common profile/data drives\r\n| summarize \r\n    AvgReadThroughputMBps = avg(iff(CounterName == \"Disk Read Bytes/sec\", CounterValue / 1048576, 0)),\r\n    AvgWriteThroughputMBps = avg(iff(CounterName == \"Disk Write Bytes/sec\", CounterValue / 1048576, 0)),\r\n    PeakReadThroughputMBps = max(iff(CounterName == \"Disk Read Bytes/sec\", CounterValue / 1048576, 0)),\r\n    PeakWriteThroughputMBps = max(iff(CounterName == \"Disk Write Bytes/sec\", CounterValue / 1048576, 0)),\r\n    AvgQueueDepth = avg(iff(CounterName == \"Current Disk Queue Length\", CounterValue, 0)),\r\n    AvgReadLatencyMs = avg(iff(CounterName == \"Avg. Disk sec/Read\", CounterValue * 1000, 0)),\r\n    AvgWriteLatencyMs = avg(iff(CounterName == \"Avg. Disk sec/Write\", CounterValue * 1000, 0))\r\n    by Computer, DiskLetter\r\n| extend \r\n    TotalThroughputMBps = AvgReadThroughputMBps + AvgWriteThroughputMBps,\r\n    PeakTotalThroughputMBps = PeakReadThroughputMBps + PeakWriteThroughputMBps,\r\n    AvgLatencyMs = (AvgReadLatencyMs + AvgWriteLatencyMs) / 2\r\n| summarize \r\n    TotalSessionHosts = dcount(Computer),\r\n    AvgThroughputMBps = round(avg(TotalThroughputMBps), 1),\r\n    PeakThroughputMBps = round(max(PeakTotalThroughputMBps), 1),\r\n    AvgLatencyMs = round(avg(AvgLatencyMs), 2),\r\n    MaxQueueDepth = round(max(AvgQueueDepth), 1)\r\n| extend \r\n    ANFPerformanceTier = case(\r\n        PeakThroughputMBps > 400, \"Ultra\",\r\n        PeakThroughputMBps > 160, \"Premium\", \r\n        \"Standard\"\r\n    ),\r\n    StorageRecommendation = case(\r\n        AvgLatencyMs > 20, \"Consider Premium/Ultra ANF for lower latency\",\r\n        PeakThroughputMBps > 100, \"Premium ANF recommended for throughput requirements\",\r\n        \"Standard ANF may be sufficient\"\r\n    )",
        "size": 3,
        "title": "🎯 Storage Performance Summary",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "TotalSessionHosts",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "AvgThroughputMBps",
              "formatter": 4,
              "formatOptions": {
                "palette": "green"
              },
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "decimal",
                  "maximumFractionDigits": 1
                }
              }
            },
            {
              "columnMatch": "PeakThroughputMBps",
              "formatter": 4,
              "formatOptions": {
                "palette": "orange"
              },
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "decimal",
                  "maximumFractionDigits": 1
                }
              }
            },
            {
              "columnMatch": "AvgLatencyMs",
              "formatter": 4,
              "formatOptions": {
                "palette": "red",
                "thresholds": [
                  {
                    "color": "green",
                    "value": 0
                  },
                  {
                    "color": "yellow",
                    "value": 10
                  },
                  {
                    "color": "red",
                    "value": 20
                  }
                ]
              }
            },
            {
              "columnMatch": "ANFPerformanceTier",
              "formatter": 18,
              "formatOptions": {
                "thresholds": [
                  {
                    "color": "green",
                    "value": "Standard"
                  },
                  {
                    "color": "yellow",
                    "value": "Premium"
                  },
                  {
                    "color": "red",
                    "value": "Ultra"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "StoragePerformanceSummary"
    },
    {
      "type": 1,
      "content": {
        "json": "## 👥 User Session Analytics\r\n\r\nAnalyze user patterns, peak usage times, and session characteristics for capacity planning."
      },
      "name": "UserSessionHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// User Session Patterns and Peak Usage Analysis\r\nlet timeRange = {TimeRange};\r\nPerf\r\n| where TimeGenerated >= ago({TimeRange:grain})\r\n| where CounterName == \"Active Sessions\"\r\n| where ObjectName == \"Terminal Services\"\r\n| summarize \r\n    ActiveSessions = avg(CounterValue),\r\n    PeakSessions = max(CounterValue)\r\n    by Computer, bin(TimeGenerated, 1h)\r\n| summarize \r\n    TotalSessionHosts = dcount(Computer),\r\n    AvgConcurrentUsers = round(avg(ActiveSessions), 0),\r\n    PeakConcurrentUsers = round(max(PeakSessions), 0),\r\n    PeakHour = format_datetime(arg_max(TimeGenerated, PeakSessions), \"yyyy-MM-dd HH:mm\")\r\n    by bin(TimeGenerated, 1h)\r\n| extend \r\n    HourOfDay = datetime_part(\"hour\", TimeGenerated),\r\n    DayOfWeek = format_datetime(TimeGenerated, \"dddd\")\r\n| order by TimeGenerated asc",
        "size": 0,
        "title": "📊 Hourly User Session Patterns",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "visualization": "timechart"
      },
      "name": "UserSessionPatterns"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Peak Usage Hours Analysis\r\nPerf\r\n| where TimeGenerated >= ago({TimeRange:grain})\r\n| where CounterName == \"Active Sessions\"\r\n| where ObjectName == \"Terminal Services\"\r\n| extend HourOfDay = datetime_part(\"hour\", TimeGenerated)\r\n| summarize \r\n    AvgSessions = avg(CounterValue),\r\n    PeakSessions = max(CounterValue)\r\n    by HourOfDay\r\n| order by HourOfDay asc\r\n| extend Hour = strcat(HourOfDay, \":00\")",
              "size": 1,
              "title": "🕐 Peak Usage Hours",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "PeakUsageHours"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Profile Performance Analysis\r\nPerf\r\n| where TimeGenerated >= ago({TimeRange:grain})\r\n| where CounterName in (\"Profile loads\", \"Profile unloads\")\r\n| where ObjectName == \"User Profile Service\"\r\n| summarize \r\n    ProfileLoads = sum(iff(CounterName == \"Profile loads\", CounterValue, 0)),\r\n    ProfileUnloads = sum(iff(CounterName == \"Profile unloads\", CounterValue, 0))\r\n    by Computer, bin(TimeGenerated, 1h)\r\n| summarize \r\n    TotalLoads = sum(ProfileLoads),\r\n    TotalUnloads = sum(ProfileUnloads),\r\n    AvgLoadsPerHour = round(avg(ProfileLoads), 1),\r\n    PeakLoadsPerHour = max(ProfileLoads)\r\n    by bin(TimeGenerated, 1h)\r\n| extend ProfileTurnover = round(TotalLoads * 1.0 / nullif(TotalUnloads, 0), 2)\r\n| project TimeGenerated, TotalLoads, TotalUnloads, AvgLoadsPerHour, PeakLoadsPerHour",
              "size": 1,
              "title": "👤 Profile Load/Unload Activity",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "ProfileActivity"
          }
        ]
      },
      "name": "UserAnalyticsGroup"
    },
    {
      "type": 1,
      "content": {
        "json": "## 💾 Storage Performance Deep Dive\r\n\r\nDetailed analysis of disk performance metrics to inform ANF sizing decisions."
      },
      "name": "StorageDeepDiveHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Storage Performance Analysis - IOPS and Throughput\r\nPerf\r\n| where TimeGenerated >= ago({TimeRange:grain})\r\n| where CounterName in (\"Disk Reads/sec\", \"Disk Writes/sec\", \"Disk Read Bytes/sec\", \"Disk Write Bytes/sec\")\r\n| where InstanceName != \"_Total\" and InstanceName !contains \"Harddisk\"\r\n| extend DiskLetter = extract(@\"([A-Z]):\", 1, InstanceName)\r\n| where DiskLetter in (\"C\", \"D\", \"O\", \"P\", \"S\", \"T\", \"U\", \"V\", \"W\", \"X\", \"Y\", \"Z\")\r\n| summarize \r\n    ReadIOPS = avg(iff(CounterName == \"Disk Reads/sec\", CounterValue, 0)),\r\n    WriteIOPS = avg(iff(CounterName == \"Disk Writes/sec\", CounterValue, 0)),\r\n    ReadThroughputMBps = avg(iff(CounterName == \"Disk Read Bytes/sec\", CounterValue / 1048576, 0)),\r\n    WriteThroughputMBps = avg(iff(CounterName == \"Disk Write Bytes/sec\", CounterValue / 1048576, 0))\r\n    by Computer, DiskLetter, bin(TimeGenerated, 5m)\r\n| extend \r\n    TotalIOPS = ReadIOPS + WriteIOPS,\r\n    TotalThroughputMBps = ReadThroughputMBps + WriteThroughputMBps\r\n| summarize \r\n    AvgIOPS = avg(TotalIOPS),\r\n    PeakIOPS = max(TotalIOPS),\r\n    AvgThroughputMBps = avg(TotalThroughputMBps),\r\n    PeakThroughputMBps = max(TotalThroughputMBps)\r\n    by bin(TimeGenerated, 15m)\r\n| order by TimeGenerated asc",
        "size": 0,
        "title": "📈 IOPS and Throughput Trends",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "visualization": "timechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "AvgIOPS",
              "label": "Average IOPS",
              "color": "blue"
            },
            {
              "seriesName": "PeakIOPS",
              "label": "Peak IOPS",
              "color": "red"
            },
            {
              "seriesName": "AvgThroughputMBps",
              "label": "Avg Throughput (MB/s)",
              "color": "green"
            },
            {
              "seriesName": "PeakThroughputMBps",
              "label": "Peak Throughput (MB/s)",
              "color": "orange"
            }
          ]
        }
      },
      "name": "IOPSThroughputTrends"
    }
  ]
}
